#!/bin/sh

TARGET_FILE="/lib/firmware/wlan/wlan_mac.bin"
SOURCE_FILE="/var/persist/wlan_mac.bin"
OUTPUT_FILE="/etc/bluetooth/.bt_nv.bin"
NVDATA_FILE="/var/persist/NV_data"

DEFAULT_MAC="005533225511"

if [ ! -f "$NVDATA_FILE" ]; then
    echo "Error: NV_DATA file not found: $NVDATA_FILE"
    exit 1
fi

RAW_LINE=$(grep -aEo "Quec-Head-nv1-v1.*Quec-Tail-nv1-v1" "$NVDATA_FILE" | tr -d '\0\n\r ')

if [ -z "$RAW_LINE" ]; then
    echo "Invalid file format: Quec pattern not found"
    exit 1
fi

TAIL="Quec-Tail-nv1-v1"
if [ ${#RAW_LINE} -le 65 ]; then
    echo "Invalid NV_DATA length: ${#RAW_LINE}"
    exit 1
fi

MAC_START=$(( ${#RAW_LINE} - ${#TAIL} - 12 ))
MAC=${RAW_LINE:$MAC_START:12}
MAC=$(echo "$MAC" | tr '[:lower:]' '[:upper:]')

if [[ ! "$MAC" =~ ^[0-9A-F]{12}$ ]] || [[ "$MAC" =~ ^0+$ ]]; then
    echo "Detected empty/invalid MAC, using default $DEFAULT_MAC"
    MAC="$DEFAULT_MAC"
fi

{
    printf "\x00\x00\x06"
    for i in 10 8 6 4 2 0; do
        printf "\x${MAC:$i:2}"
    done
} > "$OUTPUT_FILE"

echo "BT MAC ($MAC) written to $OUTPUT_FILE"

if [ $? -eq 0 ]; then
    echo "BT MAC ($MAC) written to $OUTPUT_FILE"
else
    echo "Failed to write BT MAC"
    exit 1
fi

killall -9 hciattach
echo 0 > /sys/devices/platform/rfkill/bt_en
sleep 1
echo 1 > /sys/devices/platform/rfkill/bt_en
sleep 1
hciattach /dev/ttyHS1 qca -t120 3000000 flow

if [ ! -f "$SOURCE_FILE" ]; then
    echo "wlan_mac.bin is not set maybe not set by fct mode"
    exit 0
fi

if [ ! -f "$TARGET_FILE" ] || ! cmp -s <(md5sum "$TARGET_FILE" | cut -d ' ' -f 1) <(md5sum "$SOURCE_FILE" | cut -d ' ' -f 1); then
    echo "wlan_mac.bin file is different..."

    mount -o remount,rw /usr
    if [ $? -ne 0 ]; then
        echo "failed to remount /usr "
        exit 1
    fi

    cp "$SOURCE_FILE" "$TARGET_FILE"
    if [ $? -eq 0 ]; then
        echo "copy file successs $TARGET_FILE"
    else
        echo "failed to copy Macfile"
        mount -o remount,ro /usr
        exit 1
    fi

    mount -o remount,ro /usr
    echo "/usr has changed to RO"
else
    echo "Mac.bin is not change"
fi

echo "reload wlan driver"
rmmod wlan
sleep 1
insmod /lib/modules/6.6.52-qli-1.3-ver.1.1/updates/wlan.ko
sleep 1
ifconfig wlan0 up
echo "reload wlan driver success"
